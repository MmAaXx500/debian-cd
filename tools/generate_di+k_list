#!/bin/sh

# Generate a list of packages required for debian-installer
# This script makes use of the following variables that need to be preset:
# MIRROR, CODENAME, DI_CODENAME
if [ "$MIRROR"x = ""x ] ; then
    echo "\$MIRROR unset; abort!"
    exit 1
fi
if [ "$CODENAME"x = ""x ] ; then
    echo "\$CODENAME unset; abort!"
    exit 1
fi
if [ "$DI_CODENAME"x = ""x ] ; then
    echo "\$DI_CODENAME unset; abort!"
    exit 1
fi

DATE=`date`
cat > debian-installer+kernel-$DI_CODENAME << EOF
/* These packages + the ones needed by debootstrap are the ones needed for
 * debian-installer to be able to install a base Debian system.
 *
 * These packages are installed by various parts of the debian-installer,
 * mostly via its apt-install command.
 *
 * This list can be generated with the command:
 * ../tools/generate_di+k_list
 *
 * DO NOT EDIT THIS FILE, edit the above script
 *
 * Last update: $DATE
 */

#include <debian-installer-$DI_CODENAME>
eject
locales
libdevmapper1.02
lvm-common
lvm2
mdadm
aptitude
jfbterm
unifont
hotplug
usbutils
console-cyrillic
console-terminus
pcmcia-cs
pcmciautils
wireless-tools
xfsprogs
jfsutils
dosfsutils
reiserfsprogs
libfribidi0
localization-config
acpid
ppp
pppoeconf
udev
installation-report
openssh-server
cryptsetup

/* libsysfs1-udeb provides libsysfs1 so we have to make sure the deb
 * gets included on the first CD too
 */
libsysfs1

/* Needed for rootless installs. */
sudo

#ifdef ARCH_i386
initramfs-tools
discover
discover1
grub
lilo
/* Note that we do not have to include every optimised kernel flavor for
 * i386, but this does control what kernels are available on the netinst CD.
 * Kernel headers are included as third party modules are commonly
 * used on this architecture.
 */
kernel-image-2.4-386
kernel-pcmcia-modules-2.4-386
kernel-headers-2.4-386
linux-image-2.6-486
linux-headers-2.6-486
linux-image-2.6-686
linux-headers-2.6-686
#endif

#ifdef ARCH_amd64
initramfs-tools
discover
discover1
grub
lilo
linux-image-2.6-amd64-generic
linux-headers-2.6-amd64-generic
#endif

#ifdef ARCH_alpha
initramfs-tools
aboot
aboot-base
discover1
linux-image-2.6-alpha-generic
linux-image-2.6-alpha-smp
#endif

#ifdef ARCH_hppa
initramfs-tools
discover1
linux-image-2.6-parisc
linux-image-2.6-parisc-smp
linux-image-2.6-parisc64
linux-image-2.6-parisc64-smp
palo
#endif

#ifdef ARCH_ia64
initramfs-tools
discover1
linux-image-2.6-itanium
linux-image-2.6-itanium-smp
linux-image-2.6-mckinley
linux-image-2.6-mckinley-smp
elilo
#endif

#ifdef ARCH_mips
yaird
arcboot
sibyl
EOF

# Only include mips kernels that d-i base-installer installs.
# XXX once mips gets kernel-image-2.4-<subarch> packages, use those
# instead.
for subarch in r4k-ip22 r5k-ip22 sb1-swarm-bn; do
    zcat $MIRROR/dists/$CODENAME/main/binary-mips/Packages.gz | \
	    sed -n 's/Package: \(kernel-image-.*-.*\)$/\1/p' | \
		grep -- "-$subarch$" | sort -n | tail -n 1 \
                >> debian-installer+kernel-$DI_CODENAME
done

cat >> debian-installer+kernel-$DI_CODENAME << EOF
#endif

#ifdef ARCH_mipsel
yaird
sibyl
colo
delo
EOF

# Only include mipsel kernels that d-i base-installer installs.
# XXX once mips gets kernel-image-2.4-<subarch> packages, use those
# instead.
for subarch in r3k-kn02 r4k-kn04 cobalt lasat; do
    zcat $MIRROR/dists/$CODENAME/main/binary-mipsel/Packages.gz | \
	    sed -n 's/Package: \(kernel-image-.*-.*\)$/\1/p' | \
		grep -- "-$subarch$" | sort -n | tail -n 1 \
                >> debian-installer+kernel-$DI_CODENAME
done

cat >> debian-installer+kernel-$DI_CODENAME << EOF
#endif

#ifdef ARCH_powerpc
initramfs-tools
discover1
quik
yaboot
powerpc-utils
hfsutils
mkvmlinuz
module-init-tools
linux-image-2.6-powerpc
linux-image-2.6-powerpc-smp
linux-image-2.6-powerpc64
EOF

# Only include powerpc kernels that d-i base-installer installs.
# XXX once powerpc 2.4 gets kernel-image-2.4-<subarch> packages, use those
# instead, but beware of apus.
for subarch in powerpc power3 power4 power3-pmac power3-chrp-rs6k \
		power4-pmac power4-chrp-rs6k powerpc-pmac \
		powerpc-prep powerpc-chrp powerpc-chrp-rs6k apus; do
	zcat $MIRROR/dists/$CODENAME/main/binary-powerpc/Packages.gz | \
	    sed -n 's/Package: \(kernel-image-.*-.*\)$/\1/p' | \
		grep -- "-$subarch$" | sort -n | tail -n 1 \
                >> debian-installer+kernel-$DI_CODENAME
done

cat >> debian-installer+kernel-$DI_CODENAME << EOF
#endif

#ifdef ARCH_sparc
initramfs-tools
silo
discover1
linux-image-2.6-sparc32
linux-image-2.6-sparc32-smp
linux-image-2.6-sparc64
linux-image-2.6-sparc64-smp
#endif

#ifdef ARCH_m68k
initramfs-tools
fileutils
amiboot
atari-bootstrap
emile
vmelilo
linux-image-2.6-amiga
linux-image-2.6-mac
EOF

# Get the latest 2.2 kernel for mac 
  zcat $MIRROR/dists/$CODENAME/main/binary-m68k/Packages.gz | \
      sed -n 's/Package: \(kernel-image-2.2.*-mac\)$/\1/p' | \
      tail -n 1 \
      >> debian-installer+kernel-$DI_CODENAME
	  
# Get the latest kernels for 2.4 d-i subarchs
# XXX once m68k gets kernel-image-2.4-<subarch> packages, use those
# instead.
for subarch in amiga atari bvme6000 mvme147 mvme16x q40; do
  zcat $MIRROR/dists/$CODENAME/main/binary-m68k/Packages.gz | \
    sed -n 's/Package: \(kernel-image-2.4.*\)$/\1/p' | \
    grep -- "-$subarch$" | sort -n | tail -n 1 \
		>> debian-installer+kernel-$DI_CODENAME
done

cat >> debian-installer+kernel-$DI_CODENAME << EOF

#endif

#ifdef ARCH_arm
initramfs-tools
discover1
nwutil
slugimage
nslu2-utils
EOF

zcat $MIRROR/dists/$CODENAME/main/binary-arm/Packages.gz | \
    sed -n 's/Package: \(kernel-image-2.4.*\)$/\1/p' | \
    tail -n5 \
    >> debian-installer+kernel-$DI_CODENAME

cat >> debian-installer+kernel-$DI_CODENAME << EOF
linux-image-2.6-footbridge
linux-image-2.6-ixp4xx
linux-image-2.6-nslu2
linux-image-2.6-rpc
linux-image-2.6-s3c2410
#endif
EOF
