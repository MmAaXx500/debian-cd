#!/bin/bash

cd $1

:> MD5SUMS
:> SHA1SUMS

echo "Generating checksums from files in $1"

case $DOJIGDO in
	0)
		for file in `find * -name \*.iso -o -name \*.raw`
		do
			md5sum $file >> MD5SUMS
			sha1sum $file >> SHA1SUMS
		done
		;;
	1|2)
		for file in `find * -name \*.jigdo`
		do
            iso=${file%%.jigdo}.iso

			grep -q $iso MD5SUMS
            if [ $? -ne 0 ] ; then
			    MD5=`zcat -f $file | awk '/Image Hex MD5Sum/ {print $5}'`
                if [ "$MD5"x != ""x ] ; then
                    echo "$MD5  $iso" >> MD5SUMS
                else
                    echo "Jigdo file does not contain the Image MD5, calculating by hand"
                    md5sum $iso >> MD5SUMS
                fi
            fi

			grep -q $iso SHA1SUMS
            if [ $? -ne 0 ] ; then
			    SHA1=`zcat -f $file | awk '/Image Hex SHA1Sum/ {print $5}'`
                if [ "$SHA1"x != ""x ] ; then
                    echo "$SHA1  $iso" >> SHA1SUMS
                else
                    echo "Jigdo file does not contain the Image SHA1, calculating by hand"
                    sha1sum $iso >> SHA1SUMS
                fi
            fi
		done
		;;
	*)
		echo "DOJIGDO not defined!"
		exit 1
		;;
esac
